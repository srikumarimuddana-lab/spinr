name: CI

on:
  push:
    branches: [ main, vscode_20260211 ]
  pull_request:
    branches: [ main ]

jobs:
  # ──────────────────────────────────────────────
  # 1. Backend — Python tests
  # ──────────────────────────────────────────────
  test-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    strategy:
      matrix:
        python-version: [3.12]
    env:
      FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
      ANNOTATE_TESTS_PATTERN: ''
      FAIL_THRESHOLD: '-1'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Install test tools
        run: pip install pytest pytest-asyncio

      - name: Run backend tests (full)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest -q --junitxml=junit.xml

      - name: Run filtered tests for annotation (optional)
        if: ${{ env.ANNOTATE_TESTS_PATTERN != '' }}
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "Running tests matching pattern: $ANNOTATE_TESTS_PATTERN"
          pytest -q -k "$ANNOTATE_TESTS_PATTERN" --junitxml=annotate_junit.xml || true

      - name: Enforce test failure threshold
        env:
          FAIL_THRESHOLD: ${{ env.FAIL_THRESHOLD }}
        run: |
          python - <<'PY'
          import os, sys
          from xml.etree import ElementTree as ET
          p = 'junit.xml'
          if not os.path.exists(p):
              print('No junit.xml produced')
              sys.exit(0)
          try:
              tree = ET.parse(p)
              root = tree.getroot()
              failures = 0
              for ts in root.findall('.//testsuite'):
                  failures += int(ts.attrib.get('failures', '0')) + int(ts.attrib.get('errors', '0'))
              if failures == 0:
                  failures = len(root.findall('.//failure')) + len(root.findall('.//error'))
              threshold = int(os.environ.get('FAIL_THRESHOLD', '-1'))
              print(f"Detected failures+errors: {failures}; threshold={threshold}")
              if threshold >= 0 and failures > threshold:
                  print(f"Failing job because failures ({failures}) > threshold ({threshold})")
                  sys.exit(2)
              sys.exit(0)
          except Exception as e:
              print('Error while parsing junit.xml:', e)
              sys.exit(0)
          PY

      - name: Upload test results (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report
          path: |
            tests
            junit.xml

      - name: Annotate pull request with filtered test results
        if: ${{ always() && github.event_name == 'pull_request' && env.ANNOTATE_TESTS_PATTERN != '' }}
        uses: dorny/test-reporter@v1
        with:
          name: pytest-filtered
          path: annotate_junit.xml
          reporter: java-junit
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Annotate pull request with all test results
        if: ${{ always() && github.event_name == 'pull_request' && env.ANNOTATE_TESTS_PATTERN == '' }}
        uses: dorny/test-reporter@v1
        with:
          name: pytest
          path: junit.xml
          reporter: java-junit
          token: ${{ secrets.GITHUB_TOKEN }}

  # ──────────────────────────────────────────────
  # 2. Admin Dashboard — Next.js build & lint
  # ──────────────────────────────────────────────
  build-admin:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: admin-dashboard
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: admin-dashboard/package-lock.json

      - name: Install dependencies
        run: npm ci || npm install

      - name: Lint
        run: npm run lint -- --max-warnings 0
        continue-on-error: true

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: https://spinr-backend.onrender.com

  # ──────────────────────────────────────────────
  # 3. Frontend (Expo) — TypeScript type-check
  # ──────────────────────────────────────────────
  typecheck-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps || npm install --legacy-peer-deps

      - name: TypeScript type-check
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Lint
        run: npx expo lint
        continue-on-error: true
